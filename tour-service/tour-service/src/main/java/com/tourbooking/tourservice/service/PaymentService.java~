package com.tourbooking.tourservice.service;

import com.razorpay.Order;
import com.razorpay.RazorpayClient;
import com.razorpay.RazorpayException;
import com.razorpay.Utils;
import com.tourbooking.tourservice.dto.PaymentResponse;
import com.tourbooking.tourservice.dto.PaymentVerificationRequest;
import com.tourbooking.tourservice.exception.BadRequestException;
import com.tourbooking.tourservice.exception.ResourceNotFoundException;
import com.tourbooking.tourservice.model.Booking;
import com.tourbooking.tourservice.model.BookingStatus;
import com.tourbooking.tourservice.model.Payment;
import com.tourbooking.tourservice.model.Tour;
import com.tourbooking.tourservice.repository.BookingRepository;
import com.tourbooking.tourservice.repository.PaymentRepository;
import com.tourbooking.tourservice.repository.TourRepository;
import jakarta.persistence.EntityManager;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Service
public class PaymentService {

    @Autowired
    private PaymentRepository paymentRepository;

    @Autowired
    private BookingRepository bookingRepository;

    @Autowired
    private TourRepository tourRepository;

    @Autowired
    private EntityManager entityManager;  // âœ… ADD THIS


    @Value("${razorpay.key.id}")
    private String razorpayKeyId;

    @Value("${razorpay.key.secret}")
    private String razorpayKeySecret;

    @Value("${razorpay.currency}")
    private String currency;

    @Value("${razorpay.company.name}")
    private String companyName;

    // Razorpay order create karna
    @Transactional
    public PaymentResponse createPaymentOrder(Long bookingId) throws RazorpayException {
        // Booking find karna
        Booking booking = bookingRepository.findById(bookingId)
                .orElseThrow(() -> new ResourceNotFoundException("Booking not found with id: " + bookingId));

        // Check booking already paid hai ya nahi
        if ("PAID".equals(booking.getPaymentStatus())) {
            throw new BadRequestException("Booking is already paid!");
        }

        // Razorpay client initialize
        RazorpayClient razorpayClient = new RazorpayClient(razorpayKeyId, razorpayKeySecret);

        // Amount ko paise me convert (1 rupee = 100 paise)
        int amountInPaise = (int) (booking.getTotalPrice() * 100);

        // FIXED: Simple order options (NO method parameter)
        JSONObject orderRequest = new JSONObject();
        orderRequest.put("amount", amountInPaise);
        orderRequest.put("currency", currency);
        orderRequest.put("receipt", "BOOKING_" + bookingId);

        // Notes for reference
        JSONObject notes = new JSONObject();
        notes.put("bookingId", bookingId);
        notes.put("tourTitle", booking.getTour().getTitle());
        notes.put("userName", booking.getUser().getName());
        orderRequest.put("notes", notes);

        // Razorpay pe order create
        Order order = razorpayClient.orders.create(orderRequest);

        // Payment record database me save
        Payment payment = new Payment();
        payment.setBooking(booking);
        payment.setRazorpayOrderId(order.get("id"));
        payment.setAmount(booking.getTotalPrice());
        payment.setCurrency(currency);
        payment.setStatus("CREATED");

        paymentRepository.save(payment);

        // Response prepare
        PaymentResponse response = new PaymentResponse();
        response.setOrderId(order.get("id"));
        response.setCurrency(currency);
        response.setAmount(amountInPaise);
        response.setKey(razorpayKeyId);
        response.setBookingId(String.valueOf(bookingId));
        response.setUserName(booking.getUser().getName());
        response.setUserEmail(booking.getUser().getEmail());
        response.setUserPhone(booking.getUser().getPhone());

        return response;
    }

    // Payment verify karna (after successful payment from frontend)
    // âœ… OPTION 2: Split into smaller transactions
    @Transactional
    public String verifyPayment(PaymentVerificationRequest request) {
        try {
            System.out.println("ðŸ” ========== PAYMENT VERIFICATION START ==========");

            // Payment find karna
            Payment payment = paymentRepository.findByRazorpayOrderId(request.getRazorpayOrderId())
                    .orElseThrow(() -> new ResourceNotFoundException("Payment not found!"));

            // Signature verify karna
            JSONObject options = new JSONObject();
            options.put("razorpay_order_id", request.getRazorpayOrderId());
            options.put("razorpay_payment_id", request.getRazorpayPaymentId());
            options.put("razorpay_signature", request.getRazorpaySignature());

            boolean isValidSignature = Utils.verifyPaymentSignature(options, razorpayKeySecret);

            if (!isValidSignature) {
                payment.setStatus("FAILED");
                paymentRepository.save(payment);
                throw new BadRequestException("Invalid payment signature!");
            }

            System.out.println("âœ… Step 1: Signature verified!");

            // Update payment
            payment.setRazorpayPaymentId(request.getRazorpayPaymentId());
            payment.setRazorpaySignature(request.getRazorpaySignature());
            payment.setStatus("SUCCESS");
            payment = paymentRepository.saveAndFlush(payment);  // âœ… saveAndFlush
            System.out.println("âœ… Step 2: Payment saved");

            // Get booking ID and call separate method
            Long bookingId = payment.getBooking().getId();

            // âœ… Call separate transactional method
            confirmBookingAfterPayment(bookingId);

            return "Payment verified and booking confirmed successfully!";

        } catch (RazorpayException e) {
            System.err.println("âŒ Razorpay Exception: " + e.getMessage());
            throw new BadRequestException("Payment verification failed: " + e.getMessage());
        }
    }

    // âœ… NEW METHOD: Separate transaction for booking confirmation
    @Transactional(propagation = Propagation.REQUIRES_NEW)  // âœ… New transaction
    public void confirmBookingAfterPayment(Long bookingId) {
        System.out.println("ðŸ”„ Step 3: Confirming booking in new transaction...");

        Booking booking = bookingRepository.findById(bookingId)
                .orElseThrow(() -> new ResourceNotFoundException("Booking not found"));

        if (booking.getStatus() != BookingStatus.PENDING) {
            System.out.println("âš ï¸ Booking already confirmed");
            return;
        }

        // Fetch tour
        Tour tour = tourRepository.findById(booking.getTour().getId())
                .orElseThrow(() -> new ResourceNotFoundException("Tour not found"));

        // Deduct seats
        if (tour.getAvailableSeats() >= booking.getNumberOfSeats()) {
            tour.setAvailableSeats(tour.getAvailableSeats() - booking.getNumberOfSeats());
            tourRepository.saveAndFlush(tour);  // âœ… saveAndFlush
            System.out.println("âœ… Step 4: Seats deducted: " + booking.getNumberOfSeats());
        } else {
            throw new BadRequestException("Seats no longer available!");
        }

        // Update booking
        booking.setPaymentStatus("PAID");
        booking.setStatus(BookingStatus.CONFIRMED);
        bookingRepository.saveAndFlush(booking);  // âœ… saveAndFlush
        System.out.println("âœ… Step 5: Booking CONFIRMED!");
    }
    // Payment failed handler
    @Transactional
    public void handlePaymentFailure(String orderId, String reason) {
        Payment payment = paymentRepository.findByRazorpayOrderId(orderId)
                .orElseThrow(() -> new ResourceNotFoundException("Payment not found!"));

        payment.setStatus("FAILED");
        paymentRepository.save(payment);
    }

    // Sab payments list
    public List<Payment> getAllPayments() {
        return paymentRepository.findAll();
    }

    // Payment by ID
    public Optional<Payment> getPaymentById(Long id) {
        return paymentRepository.findById(id);
    }

    // Booking ki payment find karna
    public Optional<Payment> getPaymentByBookingId(Long bookingId) {
        return paymentRepository.findByBookingId(bookingId);
    }
}